import requests

# --- CONFIGURATION ---
BASE_URL = "http://127.0.0.1:5000/api/v1"
LOGIN_URL = f"{BASE_URL}/auth/login"

# User credentials (ensure this user exists in your DB)
EMAIL = "login@test.com"
PASSWORD = "securePass123"

def get_fresh_token():
    """Logs in and returns a valid access token."""
    response = requests.post(LOGIN_URL, json={
        "email": EMAIL,
        "password": PASSWORD
    })
    
    if response.status_code == 200:
        token = response.json().get('access_token')
        print(f"üîë Authentication Successful! Got new token.")
        return token
    else:
        print(f"‚ùå Login Failed: {response.status_code}")
        print(response.json())
        exit(1)

def test_create_place(token):
    """Test 1: Create a place (Allowed for any authenticated user)"""
    print("\n--- Testing Place Creation ---")
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    url = f"{BASE_URL}/places/"
    data = {
        "title": "Auto-Token Place",
        "description": "Created with an automatically generated token",
        "price": 75.0,
        "latitude": 12.34,
        "longitude": 56.78,
        "owner_id": "ignored" 
    }
    
    response = requests.post(url, json=data, headers=headers)
    
    if response.status_code == 201:
        print("‚úÖ SUCCESS: Place created!")
        print(f"   Place ID: {response.json().get('id')}")
        print(f"   Owner ID: {response.json().get('owner_id')}")
    else:
        print(f"‚ùå FAILED: {response.status_code}")
        print(response.json())

def test_create_amenity(token):
    """Test 2: Create an Amenity (Restricted to Admin Only)"""
    print("\n--- Testing Amenity Creation (Admin Only) ---")
    print("‚ÑπÔ∏è  NOTE: This user is NOT an admin. We expect a 403 Forbidden.")
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    url = f"{BASE_URL}/amenities/"
    data = {"name": "VIP Lounge"}
    
    response = requests.post(url, json=data, headers=headers)
    
    if response.status_code == 403:
        print("‚úÖ SUCCESS: Request was correctly blocked (403 Forbidden).")
    elif response.status_code == 201:
        print("‚ö†Ô∏è  WARNING: Request succeeded!") 
        print("   Did you implement the Admin restrictions in amenities.py yet?")
    else:
        print(f"‚ÑπÔ∏è RESULT: {response.status_code}")
        print(response.json())

if __name__ == "__main__":
    # 1. Get Token
    fresh_token = get_fresh_token()
    
    # 2. Run Tests
    test_create_place(fresh_token)
    test_create_amenity(fresh_token)
